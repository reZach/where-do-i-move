<!doctype html>
<html lang="en-US">

<head>
    <title>Where do I move?</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <link rel="stylesheet" href="https://unpkg.com/bulma@0.9.0/css/bulma.min.css" />
    <script>
        // https://stackoverflow.com/a/2450976/1837080
        function shuffle(array) {
            var currentIndex = array.length,
                temporaryValue, randomIndex;

            // While there remain elements to shuffle...
            while (0 !== currentIndex) {

                // Pick a remaining element...
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex -= 1;

                // And swap it with the current element.
                temporaryValue = array[currentIndex];
                array[currentIndex] = array[randomIndex];
                array[randomIndex] = temporaryValue;
            }

            return array;
        }
    </script>
</head>

<body>
    <section class="section">
        <div class="container">
            <div id="app">
                <h1 class="title is-1">Where do I move?</h1>
                <div class="subtitle">
                    <p>
                        A no-nonsense guide to help you understand where you should move.
                    </p>
                    <button v-on:click="start" v-bind:disabled="comparisonsActive"
                        class="button is-primary is-medium is-link mt-2">Start</button>
                    <button v-if="comparisonsActive" v-on:click="reset"
                        class="button is-danger is-medium is-link mt-2">Reset</button>
                </div>
                <div v-if="!comparisonsActive && !showResults">
                    <h2 class="title is-2">My comparisons</h2>
                    <p>
                        Below, you will see a list of factors that may affect your decision to move to a certain place
                        over another. The following list has been generated by default, but you may add or remove any
                        additional factors as you see fit.
                    </p>
                    <div class="field is-grouped">
                        <p class="control is-expanded">
                            <input v-model="newFactor" type="text" class="input" placeholder="New factor" />
                        </p>
                        <p class="control">
                            <button v-on:click="add" class="button is-primary">Add</button>
                        </p>
                    </div>
                    <button v-on:click="defaultFactors" class="button is-primary">Set default factors</button>
                    <div class="content">
                        <ul>
                            <li v-for="factor in factors" style="list-style: none;">
                                <button v-on:click="remove(factor)" class="button is-danger">Remove</button>
                                <span style="vertical-align: -moz-middle-with-baseline;">{{ factor }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
                <div v-if="comparisonsActive && !showResults">
                    <button v-on:click="choose('BACK')" class="button mb-4">Previous comparison</button>
                    <p>Choose the option you'd prefer <strong>more</strong>. Your progress is automatically saved
                        (provided you do not reset).</p>
                    <div>
                        <button v-on:click="choose('A')"
                            class="button is-info is-large">{{ comparisons[comparisonIndex].A }}</button>
                        <button v-on:click="choose('B')"
                            class="button is-info is-large">{{ comparisons[comparisonIndex].B }}</button>
                    </div>
                    <span class="mt-4">{{ ((comparisonIndex/comparisons.length) * 100).toFixed(2) }}% complete
                        ({{comparisonIndex + 1}}/{{comparisons.length}})</span>
                </div>
                <div v-if="showResults">
                    <p>Based on your answers, these are the factors that you rank by highest priority:</p>
                    <div class="content">
                        <ul>
                            <li v-for="result in results">
                                {{ result }}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <script>
        const times = [
            "<15 minutes from",
            "30-45 minutes from",
            "60-90 minutes from",
            "2+ hours from"
        ];

        const timesFactors = [
            "an ocean/sea",
            "a lake",
            "a river",
            "a forest",
            "the city",
            "the highway",
            "the airport",
            "my child's school",
            "school",
            "restaurants",
            "grocery stores",
            "the hospital",
            "healthcare facilities",
            "convenience stores",
            "shops",
            "the movie theater",
            "a sports stadium",
            "a theater (play)",
            "the nightlife",
            "church",
            "a gas station",
            "farmland",
            "mountains",
            "friends",
            "family",
            "cousins",
            "work"
        ];

        const nonTimesFactors = [

            // Drinking water
            "Prefer drinking lake water",
            "Prefer drinking ocean water",
            "Prefer drinking well water",
            "Prefer drinking bottled/boiled water",

            // Geography
            "Prefer the suburbs",
            "Prefer the city",

            // Safety
            "Prefer a less-safe area",
            "Prefer a safe area",
            "Prefer the safest area",

            // Cost
            "Low cost of living",
            "Average cost of living",
            "High cost of living",

            // City
            "Tiny city",
            "Small city",
            "Medium city",
            "Large city",
            "Very high-density city",

            // Jobs
            "No opportunity for jobs",
            "Small opportunity for jobs",
            "Large opportunity for jobs",

            // Internet
            "Average internet speed",
            "Gig-speed internet",

            // Taxes
            "Little to no taxes",
            "Average taxes",
            "High taxes",

            // Pollution
            "No pollution",
            "Average pollution",
            "Heavy pollution",

            // Commute
            "Prefer to drive",
            "Prefer to take buses",
            "Prefer to take the train",
            "Prefer to bike",
            "Prefer to walk",

            // Temperature
            "Temperature tends colder",
            "Temperature tends milder",
            "Temperature tends warmer",
            "Temperature tends hotest",

            // Weather
            "Chance of hurricanes",
            "Chance of tornadoes",
            "Chance of dust storms",
            "Chance of flooding",
            "Chance of wildfires",
            "Chance of earthquakes",
            "Chance of blizzards"
        ];

        let factors = JSON.parse(JSON.stringify(nonTimesFactors));
        for (let i = 0; i < timesFactors.length; i++) {
            for (let j = 0; j < times.length; j++) {
                factors.push(`${times[j]} ${timesFactors[i]}`);
            }
        }

        let app = new Vue({
            el: "#app",
            data: {
                newFactor: "",
                factors,
                comparisonsActive: false,
                comparisons: [],
                comparisonIndex: 0,
                workingResults: [],
                results: [],
                showResults: false
            },
            methods: {
                add: function () {
                    let existing = this.factors.indexOf(this.newFactor);

                    if (existing < 0) {
                        this.factors.push(this.newFactor);
                        this.newFactor = "";
                    }
                },
                remove: function (factor) {
                    let index = this.factors.indexOf(factor);

                    if (index >= 0) {
                        this.factors.splice(index, 1);
                    }
                },
                start: function () {
                    // Build comparisons
                    let temp = JSON.parse(JSON.stringify(this.factors));
                    temp = shuffle(temp);

                    // Build comparisons
                    for (let i = 0; i < temp.length; i++) {
                        for (let j = i + 1; j < temp.length; j++) {
                            this.comparisons.push({
                                "A": temp[i],
                                "B": temp[j]
                            });
                        }
                    }

                    // save to localstorage
                    localStorage.setItem("comparisons", JSON.stringify(this.comparisons));
                    localStorage.setItem("comparisonIndex", 0);

                    this.comparisonsActive = true;
                    this.showResults = false;
                },
                reset: function () {
                    Swal.fire({
                        title: "Are you sure?",
                        text: "You will lose all existing progress; this is not recoverable.",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#3298dc",
                        cancelButtonColor: "#f14668",
                        confirmButtonText: "I want to start all over"
                    }).then((result) => {

                        if (result.isConfirmed) {
                            this.comparisons = [];
                            this.comparisonIndex = 0;
                            this.comparisonsActive = false;
                            this.workingResults = [];
                            this.results = [];
                            this.showResults = false;

                            localStorage.removeItem("comparisons");
                            localStorage.removeItem("comparisonIndex", 0);
                            localStorage.removeItem("workingResults");
                            localStorage.removeItem("results");
                        }
                    });
                },
                defaultFactors: function () {
                    this.factors = []; // reset

                    let factors = JSON.parse(JSON.stringify(nonTimesFactors));
                    for (let i = 0; i < timesFactors.length; i++) {
                        for (let j = 0; j < times.length; j++) {
                            factors.push(`${times[j]} ${timesFactors[i]}`);
                        }
                    }

                    this.factors = factors;
                },
                choose: function (choice) {

                    if (choice === "A") {
                        this.workingResults.push(this.comparisons[this.comparisonIndex].A);
                        this.comparisonIndex++;
                    } else if (choice === "B") {
                        this.workingResults.push(this.comparisons[this.comparisonIndex].B);
                        this.comparisonIndex++;
                    } else if (choice === "BACK") {
                        this.workingResults.pop();
                        this.comparisonIndex--;
                    }

                    if (this.comparisonIndex >= this.comparisons.length) {

                        // Calculate results
                        let temp = {};
                        for (let i = 0; i < this.workingResults.length; i++) {

                            // Tally-up all results
                            if (temp.hasOwnProperty(this.workingResults[i])) {
                                temp[this.workingResults[i]] += 1;
                            } else {
                                temp[this.workingResults[i]] = 1;
                            }
                        }

                        // Sort by largest (ie. preferred) first
                        let keys = Object.keys(temp);
                        keys.sort(function (a, b) {
                            return temp[b] - temp[a];
                        });

                        // Add in count
                        let results = keys;
                        for (let i = 0; i < results.length; i++) {
                            results[i] += ` (chosen ${temp[this.results[i]]} times)`;
                        }

                        this.results = results;
                        this.showResults = true;

                        localStorage.setItem("results", this.results);
                    }

                    localStorage.setItem("workingResults", JSON.stringify(this.workingResults));
                    localStorage.setItem("comparisonIndex", this.comparisonIndex);
                }
            }
        });


        // Load saved data if it exists in localstorage
        let workingResults = localStorage.getItem("workingResults");
        let comparisons = localStorage.getItem("comparisons");
        let comparisonIndex = localStorage.getItem("comparisonIndex");
        let results = localStorage.getItem("results");

        if (results !== null) {

            results = JSON.parse(results);
            if (results.length > 0) {
                app.results = results;
                app.showResults = true;

                console.log("Loaded results from localstorage");
            } else {
                console.warn("Found results but could not parse and load them on page load");
            }
        } else if (comparisons !== null &&
            comparisonIndex !== null) {

            comparisons = JSON.parse(comparisons);
            comparisonIndex = parseInt(comparisonIndex, 10);

            if (comparisons.length > 0 && comparisonIndex >= 0) {
                app.comparisons = comparisons;
                app.comparisonIndex = comparisonIndex;
                app.comparisonsActive = true;

                if (workingResults !== null) {
                    workingResults = JSON.parse(workingResults);

                    app.workingResults = workingResults;

                    console.log("Loaded existing progress from localstorage");
                } else {
                    // Start over if we can't re-load working results
                    app.comparisonIndex = 0;

                    console.warn("Could not find existing progress from localstorage");
                }
            } else {
                console.warn("Could not find any comparisons to load");
            }
        } else {
            console.log("Nothing found in localstorage");
        }
    </script>
</body>

</html>